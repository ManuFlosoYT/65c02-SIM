name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container: fedora:latest
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - name: Install dependencies
        run: |
          dnf -y update
          dnf -y install libstdc++-static gcc-c++ ninja-build mesa-libGL-devel mesa-libGLU-devel libX11-devel libXrandr-devel libXinerama-devel libXcursor-devel libXi-devel wayland-devel libxkbcommon-devel alsa-lib-devel pulseaudio-libs-devel cmake cc65 openssl-devel ccache git tar which wget curl gcc git-core make fribidi-devel pipewire-devel libXext-devel libXfixes-devel libXScrnSaver-devel libXtst-devel dbus-devel ibus-devel systemd-devel mesa-libGLES-devel mesa-libEGL-devel vulkan-devel wayland-protocols-devel libdrm-devel mesa-libgbm-devel libusb1-devel libdecor-devel pipewire-jack-audio-connection-kit-devel libthai-devel liburing-devel zlib-ng-compat-static python3-jinja2

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Git Trust
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-linux-${{ github.sha }}
          restore-keys: |
            ccache-linux-

      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: deps-linux-${{ hashFiles('CMakeLists.txt') }}

      - name: Build Linux
        run: |
          chmod +x build-linux.sh
          ./build-linux.sh

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SIM_65C02-linux
          path: output/linux/SIM_65C02

  build-windows:
    runs-on: ubuntu-latest
    container: fedora:latest
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - name: Install dependencies
        run: |
          dnf -y update
          dnf -y install libstdc++-static ninja-build mingw64-gcc mingw64-gcc-c++ mingw32-gcc mingw32-gcc-c++ cmake mingw64-openssl mingw64-openssl-static mingw64-zlib-static ccache git tar which gcc-c++ mesa-libGL-devel mesa-libGLU-devel libX11-devel libXrandr-devel libXinerama-devel libXcursor-devel libXi-devel wayland-devel libxkbcommon-devel alsa-lib-devel pulseaudio-libs-devel cc65 openssl-devel wget curl gcc git-core make fribidi-devel pipewire-devel libXext-devel libXfixes-devel libXScrnSaver-devel libXtst-devel dbus-devel ibus-devel systemd-devel mesa-libGLES-devel mesa-libEGL-devel vulkan-devel wayland-protocols-devel libdrm-devel mesa-libgbm-devel libusb1-devel libdecor-devel pipewire-jack-audio-connection-kit-devel libthai-devel liburing-devel zlib-ng-compat-static python3-jinja2

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Git Trust
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-windows-${{ github.sha }}
          restore-keys: |
            ccache-windows-

      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: build_win/_deps
          key: deps-windows-${{ hashFiles('CMakeLists.txt') }}

      - name: Build Windows
        run: |
          chmod +x build-win.sh
          ./build-win.sh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SIM_65C02-windows
          path: output/windows/SIM_65C02.exe

      - name: Upload Unit Tests
        uses: actions/upload-artifact@v4
        with:
          name: windows-unit-tests
          path: build_win/unit_tests.exe

  test-windows:
    needs: build-windows
    runs-on: ubuntu-latest
    steps:
      - name: Install Wine
        run: |
          sudo dpkg --add-architecture i386
          sudo apt-get update
          sudo apt-get install -y wine64 wine32

      - name: Download Unit Tests
        uses: actions/download-artifact@v4
        with:
          name: windows-unit-tests
          path: .

      - name: Run Windows Tests
        run: wine unit_tests.exe

  sdk:
    runs-on: ubuntu-latest
    container: fedora:latest
    steps:
      - name: Install dependencies
        run: |
          dnf -y update
          dnf -y install cc65 python3-pillow python3-mido zip

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Git Trust
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Create SDK
        run: |
          chmod +x compile-bin.sh image-to-bin.sh midi-to-bin.sh
          ./compile-bin.sh all
          ./image-to-bin.sh all
          ./midi-to-bin.sh all
          zip -r SDK.zip Binaries/ Linker/ GPU/ SID/ output/ compile-bin.sh image-to-bin.sh midi-to-bin.sh -x "Binaries/build/*"

      - name: Upload SDK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SDK
          path: SDK.zip

  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, test-windows, sdk]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: SIM_65C02-linux
          path: output/linux

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: SIM_65C02-windows
          path: output/windows

      - name: Download SDK Artifact
        uses: actions/download-artifact@v4
        with:
          name: SDK
          path: .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            output/linux/SIM_65C02
            output/windows/SIM_65C02.exe
            SDK.zip

  update-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          path: main-repo

      - name: Checkout wiki repo
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}.wiki
          path: wiki-repo

      - name: Sync files and push to Wiki
        run: |
          rsync -av --delete --exclude='.git/' main-repo/wiki/ wiki-repo/

          cd wiki-repo

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          git add .

          if git diff-index --quiet HEAD --; then
            echo "No changes in wiki to sync."
          else
            git commit -m "Auto-sync wiki for tag ${{ github.ref_name }}"
            git push
          fi
