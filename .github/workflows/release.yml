name: Build and Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    # Aquí definimos que todo corra dentro de Fedora
    container: fedora:latest
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - name: Install dependencies
        # Actualizamos e instalamos las dependencias exactas que pediste para Fedora
        run: |
          dnf -y update
          dnf -y install gcc-c++ ninja-build mingw64-gcc mingw64-gcc-c++ mingw32-gcc mingw32-gcc-c++ mesa-libGL-devel mesa-libGLU-devel libX11-devel libXrandr-devel libXinerama-devel libXcursor-devel libXi-devel wayland-devel libxkbcommon-devel alsa-lib-devel pulseaudio-libs-devel cmake cc65 openssl-devel ccache git tar which wget curl

      - name: Checkout code
        uses: actions/checkout@v4

      # Solución necesaria cuando se usa git dentro de un contenedor en GHA
      - name: Fix Git Trust
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-linux-${{ github.sha }}
          restore-keys: |
            ccache-linux-

      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: build/_deps
          key: deps-linux-${{ hashFiles('CMakeLists.txt') }}

      - name: Build Linux
        run: |
          chmod +x build-linux.sh
          ./build-linux.sh

      - name: Upload Linux Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SIM_65C02-linux
          path: output/linux/SIM_65C02

  build-windows:
    runs-on: ubuntu-latest
    # Fedora tiene excelente soporte para MinGW, ideal para cross-compile
    container: fedora:latest
    env:
      CCACHE_DIR: ${{ github.workspace }}/.ccache
    steps:
      - name: Install dependencies
        # Instalamos dependencias de MinGW (GCC, OpenSSL, Zlib) y Wine
        run: |
          dnf -y update
          dnf -y install ninja-build mingw64-gcc mingw32-gcc cmake mingw64-openssl mingw64-openssl-static mingw64-zlib-static wine ccache git tar which

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Fix Git Trust
        run: git config --global --add safe.directory $GITHUB_WORKSPACE

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: .ccache
          key: ccache-windows-${{ github.sha }}
          restore-keys: |
            ccache-windows-

      - name: Cache CMake dependencies
        uses: actions/cache@v4
        with:
          path: build_win/_deps
          key: deps-windows-${{ hashFiles('CMakeLists.txt') }}

      - name: Build Windows
        run: |
          chmod +x build-win.sh
          ./build-win.sh

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SIM_65C02-windows
          path: output/windows/SIM_65C02.exe

  # El SDK solo necesita comprimir archivos, ubuntu-latest es suficiente y más rápido
  sdk:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create SDK
        run: |
          zip -r SDK.zip Binaries/ Linker/ GPU/ SID/ compile-bin.sh image-to-bin.sh midi-to-bin.sh -x "Binaries/build/*"

      - name: Upload SDK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: SDK
          path: SDK.zip

  # La release solo mueve archivos, ubuntu-latest es suficiente
  release:
    runs-on: ubuntu-latest
    needs: [build-linux, build-windows, sdk]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: Download Linux Artifact
        uses: actions/download-artifact@v4
        with:
          name: SIM_65C02-linux
          path: output/linux

      - name: Download Windows Artifact
        uses: actions/download-artifact@v4
        with:
          name: SIM_65C02-windows
          path: output/windows

      - name: Download SDK Artifact
        uses: actions/download-artifact@v4
        with:
          name: SDK
          path: .

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            output/linux/SIM_65C02
            output/windows/SIM_65C02.exe
            SDK.zip